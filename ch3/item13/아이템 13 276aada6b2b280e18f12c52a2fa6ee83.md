# 아이템 13

## 주요 문제점

**Cloneable 인터페이스의 설계 결함:**

- clone 메서드가 Object 클래스에 protected로 선언되어 있음
- Cloneable 구현만으로는 외부에서 clone 호출 불가
- 인터페이스가 상위 클래스의 메서드 동작을 변경하는 이례적 구조

## **올바른 clone 구현 방법**

기본 타입/불변 객체만 있는 경우

```java
public class Person implements Cloneable {

    private String name;
    private int age;
    private final long id;

    public Person(String name, int age, long id) {
        this.name = name;
        this.age = age;
        this.id = id;
    }

    @Override
    protected Person clone() throws CloneNotSupportedException {
        try {
            return (Person) super.clone();
        } catch (CloneNotSupportedException e) {
            throw new CloneNotSupportedException();
        }
    }

    @Override
    public boolean equals(Object object) {
        if (object == null || getClass() != object.getClass()) return false;
        Person person = (Person) object;
        return age == person.age && id == person.id && Objects.equals(name, person.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(name, age, id);
    }
}

public static void main(String[] args) throws CloneNotSupportedException {
    Person originalPerson = new Person("김동현", 25, 1L);
    Person clonePerson = originalPerson.clone();

    System.out.println(originalPerson != clonePerson); // true
    System.out.println(originalPerson.equals(clonePerson)); // true
}

```

가변 객체를 참조

```java
public class Student implements Cloneable {

    private String name;
    private int[] scores;

    public Student(String name, int[] scores) {
        this.name = name;
        this.scores = scores;
    }

    @Override
    protected Student clone() throws CloneNotSupportedException {
        try {
            return (Student) super.clone();
        } catch (CloneNotSupportedException e) {
            e.printStackTrace();
        }

        return null;
    }

    public void updateScore(int index, int score) {
        scores[index] = score;
    }

    public int[] getScores() {
        return scores;
    }
}

public static void main(String[] args) throws CloneNotSupportedException {
    Student originalStudent = new Student("김동현", new int[]{11, 22, 33});
    Student cloneStudent = originalStudent.clone();

    originalStudent.updateScore(0, 44);

    System.out.println(Arrays.toString(originalStudent.getScores())); // [44, 22, 33]
    System.out.println(Arrays.toString(cloneStudent.getScores())); // [44, 22, 33]
    
    // 두 객체가 하나의 scores배열을 바라보고 있음
}

----------

public class Student implements Cloneable {

    private String name;
    private int[] scores;

    public Student(String name, int[] scores) {
        this.name = name;
        this.scores = scores;
    }

    @Override
    protected Student clone() throws CloneNotSupportedException {
        try {
            Student clone = (Student) super.clone();
            clone.scores = scores.clone();

            System.out.println(scores.toString());
            System.out.println(scores.clone().toString());
            
            return clone;
        } catch (CloneNotSupportedException e) {
            e.printStackTrace();
        }

        return null;
    }

    public void updateScore(int index, int score) {
        scores[index] = score;
    }

    public int[] getScores() {
        return scores;
    }
}

[I@3b07d329
[I@41629346
[44, 22, 33]
[11, 22, 33]
```

super.clone() 대신 생성자 사용의 문제점

```java
public class Vehicle implements Cloneable{

    private String brand;

    public Vehicle(String brand) {
        this.brand = brand;
    }

    @Override
    protected Vehicle clone()  {
        return new Vehicle(brand);
    }
}

public class Car extends Vehicle {

    private int doors;

    public Car(String brand, int doors) {
        super(brand);
        this.doors = doors;
    }

    @Override
    protected Car clone() {
        return (Car) super.clone(); // 여기서 형변환 예외 발생
    }
}

public static void main(String[] args) {
    Car car = new Car("a", 1);
    car.clone();
}

Exception in thread "main" java.lang.ClassCastException: class item13.Vehicle cannot be cast to class item13.Car (item13.Vehicle and item13.Car are in unnamed module of loader 'app')
	at item13.Car.clone(Car.java:14)
	at item13.Item13_3_Test.main(Item13_3_Test.java:7)
	
// car.clone()을 하면 super.clone()이 호출되고 Vehicle의 clone에서 new Vehicle을 리턴하는데
// 그 Vehicle 객체를 Car로 형변화하는 것이 불가능하기 때문
```

## 해결방법

복사 생성자

```java

public class Vehicle implements Cloneable{

    private String brand;

    public Vehicle(String brand) {
        this.brand = brand;
    }

    public Vehicle(Vehicle vehicle) {
        this.brand = vehicle.brand;
    }

    @Override
    protected Vehicle clone()  {
        return new Vehicle(brand);
    }

    public String getBrand() {
        return brand;
    }
}

public class Car extends Vehicle {

    private int doors;

    public Car(String brand, int doors) {
        super(brand);
        this.doors = doors;
    }

    public Car(Car car) {
        super(car);
        this.doors = car.doors;
    }

    @Override
    protected Car clone() {
        return (Car) super.clone();
    }

    public int getDoors() {
        return doors;
    }
}

public static void main(String[] args) {
    Car car = new Car("a", 1);
    Car car1 = new Car(car);

    System.out.println(car1.getBrand() + " " + car1.getDoors());
    System.out.println(car != car1);
}

a 1
true
```

팩터리 메서드

```java
public class Student {

    private String name;
    private int[] scores;

    public Student(String name, int[] scores) {
        this.name = name;
        this.scores = scores;
    }
    
    public Student(Student student) {
        this.name = student.name;
        this.scores = student.scores.clone();
    }
    

    public void updateScore(int index, int score) {
        scores[index] = score;
    }

    public int[] getScores() {
        return scores;
    }
}

public static void main(String[] args) throws CloneNotSupportedException {
    Student originalStudent = new Student("김동현", new int[]{11, 22, 33});
    Student cloneStudent = new Student(originalStudent);

    originalStudent.updateScore(0, 44);

    System.out.println(Arrays.toString(originalStudent.getScores()));
    System.out.println(Arrays.toString(cloneStudent.getScores()));
}

[44, 22, 33]
[11, 22, 33]
```